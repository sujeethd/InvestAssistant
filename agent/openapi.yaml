openapi: 3.1.0
info:
  title: Investment Portfolio API
  version: 0.1.0
  description: API for searching investment funds and computing summary statistics.
servers:
  - url: https://YOUR_DOMAIN_HERE
security:
  - bearerAuth: []
paths:
  /funds/search:
    post:
      operationId: searchFunds
      summary: Search funds with filters
      description: |
        Returns funds matching filters such as asset class, region, expense ratio range, etc.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FundSearchRequest"
            examples:
              default:
                value:
                  query: "s&p 500"
                  filters:
                    assetClass: "Equity"
                    region: "US"
                    expenseRatioMax: 0.10
                  limit: 20
      responses:
        "200":
          description: Matching funds
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FundListResponse"
        "400":
          description: Invalid request
        "401":
          description: Unauthorized
        "500":
          description: Server error
  /funds/summary:
    post:
      operationId: summarizeFunds
      summary: Summary statistics for selected columns
      description: |
        Computes summary stats (min/max/avg/median/count) for specific fields across a fund list.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FundSummaryRequest"
            examples:
              default:
                value:
                  fundIds: ["VFIAX", "FXAIX", "SPY"]
                  columns: ["expenseRatio", "ytdReturn", "aum"]
      responses:
        "200":
          description: Summary stats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FundSummaryResponse"
        "400":
          description: Invalid request
        "401":
          description: Unauthorized
        "500":
          description: Server error
  /portfolio/lowest-expense:
    post:
      operationId: lowestExpensePortfolio
      summary: Build a portfolio minimizing expense
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LowestExpenseRequest"
      responses:
        "200":
          description: Portfolio results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PortfolioResponse"
  /portfolio/best-return:
    post:
      operationId: bestReturnPortfolio
      summary: Build a portfolio maximizing return
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BestReturnRequest"
      responses:
        "200":
          description: Portfolio results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PortfolioResponse"
  /portfolio/optimize:
    post:
      operationId: optimizePortfolio
      summary: Optimize with weighted objective and constraints
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OptimizeRequest"
      responses:
        "200":
          description: Portfolio results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PortfolioResponse"
  /rag/search:
    post:
      operationId: ragSearch
      summary: Retrieve relevant rows for RAG
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RagSearchRequest"
      responses:
        "200":
          description: RAG results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RagSearchResponse"
  /rag/semantic:
    post:
      operationId: ragSemanticSearch
      summary: Retrieve relevant rows using vector similarity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RagSemanticRequest"
      responses:
        "200":
          description: RAG semantic results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RagSemanticResponse"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
  schemas:
    FundSearchRequest:
      type: object
      additionalProperties: false
      properties:
        query:
          type: string
          description: Free-text search string (e.g., name, ticker, benchmark).
        filters:
          type: object
          description: Structured filters for fund search.
          additionalProperties: false
          properties:
            assetClass:
              type: string
              description: Equity, Fixed Income, Multi-Asset, Alternatives, Cash
            region:
              type: string
              description: US, International, Global, Emerging Markets, etc.
            expenseRatioMin:
              type: number
            expenseRatioMax:
              type: number
            aumMin:
              type: number
              description: Minimum AUM in USD
        limit:
          type: integer
          minimum: 1
          maximum: 200
          default: 25
      required: [query]
    Fund:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
          description: Fund ID, ticker, or unique identifier.
        name:
          type: string
        assetClass:
          type: string
        region:
          type: string
        expenseRatio:
          type: number
        aum:
          type: number
          description: Assets under management in USD
        ytdReturn:
          type: number
          description: Year-to-date return (decimal or % depending on your standard)
      required: [id, name]
    FundSummaryRequest:
      type: object
      additionalProperties: false
      properties:
        fundIds:
          type: array
          items:
            type: string
          minItems: 1
        columns:
          type: array
          items: { type: string }
          minItems: 1
      required: [fundIds, columns]
    LowestExpenseRequest:
      type: object
      properties:
        table:
          type: string
          default: fund_data
        expense_column:
          type: string
        count:
          type: integer
          default: 10
        filters:
          type: array
          items:
            $ref: "#/components/schemas/Filter"
      required: [expense_column]
    BestReturnRequest:
      type: object
      properties:
        table:
          type: string
          default: fund_data
        return_column:
          type: string
        count:
          type: integer
          default: 10
        filters:
          type: array
          items:
            $ref: "#/components/schemas/Filter"
      required: [return_column]
    OptimizeRequest:
      type: object
      properties:
        table:
          type: string
          default: fund_data
        count:
          type: integer
          default: 10
        objective:
          $ref: "#/components/schemas/Objective"
        weights:
          type: object
          additionalProperties: { type: number }
        filters:
          type: array
          items:
            $ref: "#/components/schemas/Filter"
      required: [objective]
    RagSearchRequest:
      type: object
      properties:
        query:
          type: string
        table:
          type: string
          default: fund_data
        columns:
          type: array
          items: { type: string }
        text_columns:
          type: array
          items: { type: string }
        limit:
          type: integer
          default: 50
      required: [query]
    RagSemanticRequest:
      type: object
      properties:
        embedding:
          type: array
          items: { type: number }
        table:
          type: string
          default: fund_data
        embeddings_table:
          type: string
          default: fund_embeddings
        columns:
          type: array
          items: { type: string }
        limit:
          type: integer
          default: 50
      required: [embedding]
    Objective:
      type: object
      properties:
        maximize:
          type: array
          items: { type: string }
        minimize:
          type: array
          items: { type: string }
    Filter:
      type: object
      properties:
        column: { type: string }
        op:
          type: string
          enum: [=, !=, >, >=, <, <=, in, like]
        value:
          oneOf:
            - type: string
            - type: number
            - type: array
              items: { type: string }
      required: [column, op, value]
    PortfolioResponse:
      type: object
      properties:
        rows:
          type: array
          items: { type: object }
        count:
          type: integer
    FundListResponse:
      type: object
      additionalProperties: false
      properties:
        results:
          type: array
          items:
            $ref: "#/components/schemas/Fund"
        total:
          type: integer
      required: [results, total]
    FundSummaryStat:
      type: object
      additionalProperties: false
      properties:
        column:
          type: string
        count:
          type: integer
        min:
          type: number
        max:
          type: number
        mean:
          type: number
        median:
          type: number
      required: [column, count]
    FundSummaryResponse:
      type: object
      additionalProperties: false
      properties:
        stats:
          type: array
          items:
            $ref: "#/components/schemas/FundSummaryStat"
      required: [stats]
    RagSearchResponse:
      type: object
      properties:
        rows:
          type: array
          items: { type: object }
        count:
          type: integer
    RagSemanticResponse:
      type: object
      properties:
        rows:
          type: array
          items: { type: object }
        count:
          type: integer
          additionalProperties:
            type: object
            properties:
              min: { type: number }
              max: { type: number }
              avg: { type: number }
